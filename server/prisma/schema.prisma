generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("user") // user, admin
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  invoices   Invoice[]
  quotations Quotation[]
  sph        SPH[]
}

// Client/Customer model
model Client {
  id           String   @id @default(uuid())
  name         String
  contactName  String?
  email        String?
  phone        String?
  address      String?
  city         String?
  postalCode   String?
  country      String   @default("Indonesia")
  taxId        String?  // NPWP for Indonesian clients
  notes        String?
  status       String   @default("active") // active, inactive
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  invoices   Invoice[]
  quotations Quotation[]
  sph        SPH[]
}

// Invoice model
model Invoice {
  id            String   @id @default(uuid())
  invoiceNumber String   @unique
  clientId      String
  userId        String
  issueDate     DateTime @default(now())
  dueDate       DateTime
  projectName   String?
  poNumber      String?
  
  // Financial
  subtotal      Decimal  @db.Decimal(15, 2)
  taxRate       Decimal  @db.Decimal(5, 2) @default(11)
  taxAmount     Decimal  @db.Decimal(15, 2)
  discount      Decimal  @db.Decimal(15, 2) @default(0)
  total         Decimal  @db.Decimal(15, 2)
  
  // Status
  status        String   @default("draft") // draft, sent, paid, overdue, cancelled
  
  // Additional
  notes         String?
  terms         String?
  bankAccount   String?
  signatureName String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  client   Client         @relation(fields: [clientId], references: [id])
  user     User           @relation(fields: [userId], references: [id])
  items    InvoiceItem[]
  payments PaymentRecord[]
}

// Invoice Line Items
model InvoiceItem {
  id          String  @id @default(uuid())
  invoiceId   String
  description String
  quantity    Int
  rate        Decimal @db.Decimal(15, 2)
  amount      Decimal @db.Decimal(15, 2)
  
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

// Payment Records for tracking
model PaymentRecord {
  id          String   @id @default(uuid())
  invoiceId   String
  amount      Decimal  @db.Decimal(15, 2)
  paymentDate DateTime
  method      String?  // bank_transfer, cash, etc.
  reference   String?
  notes       String?
  createdAt   DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

// Quotation model (similar structure to Invoice)
model Quotation {
  id              String   @id @default(uuid())
  quotationNumber String   @unique
  clientId        String
  userId          String
  issueDate       DateTime @default(now())
  validUntil      DateTime
  projectName     String?
  
  subtotal        Decimal  @db.Decimal(15, 2)
  taxRate         Decimal  @db.Decimal(5, 2) @default(11)
  taxAmount       Decimal  @db.Decimal(15, 2)
  discount        Decimal  @db.Decimal(15, 2) @default(0)
  total           Decimal  @db.Decimal(15, 2)
  
  status          String   @default("draft") // draft, sent, accepted, rejected, expired
  notes           String?
  terms           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  client Client          @relation(fields: [clientId], references: [id])
  user   User            @relation(fields: [userId], references: [id])
  items  QuotationItem[]
}

model QuotationItem {
  id          String  @id @default(uuid())
  quotationId String
  description String
  quantity    Int
  rate        Decimal @db.Decimal(15, 2)
  amount      Decimal @db.Decimal(15, 2)
  
  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
}

// SPH (Surat Penawaran Harga) model
model SPH {
  id          String   @id @default(uuid())
  sphNumber   String   @unique
  clientId    String
  userId      String
  issueDate   DateTime @default(now())
  validUntil  DateTime
  projectName String?
  poReference String?
  
  subtotal    Decimal  @db.Decimal(15, 2)
  taxRate     Decimal  @db.Decimal(5, 2) @default(11)
  taxAmount   Decimal  @db.Decimal(15, 2)
  discount    Decimal  @db.Decimal(15, 2) @default(0)
  total       Decimal  @db.Decimal(15, 2)
  
  status      String   @default("draft") // draft, sent, accepted, rejected
  notes       String?
  terms       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client Client    @relation(fields: [clientId], references: [id])
  user   User      @relation(fields: [userId], references: [id])
  items  SPHItem[]
}

model SPHItem {
  id          String  @id @default(uuid())
  sphId       String
  model       String? // Product model/code
  description String
  quantity    Int
  unit        String  @default("unit")
  rate        Decimal @db.Decimal(15, 2)
  amount      Decimal @db.Decimal(15, 2)
  
  sph SPH @relation(fields: [sphId], references: [id], onDelete: Cascade)
}

// Company Settings
model CompanySettings {
  id               String   @id @default(uuid())
  companyName      String
  legalName        String?
  taxId            String?  // NPWP
  email            String?
  phone            String?
  address          String?
  city             String?
  postalCode       String?
  country          String   @default("Indonesia")
  logo             String?  // URL or base64
  
  // Default Tax
  defaultTaxName   String   @default("PPN")
  defaultTaxRate   Decimal  @db.Decimal(5, 2) @default(11)
  
  // Invoice Numbering
  invoicePrefix    String   @default("INV/{YYYY}/{MM}/")
  invoiceNextNum   Int      @default(1)
  invoicePadding   Int      @default(5)
  
  // Quotation Numbering
  quotationPrefix  String   @default("QT/{YYYY}/{MM}/")
  quotationNextNum Int      @default(1)
  
  // SPH Numbering
  sphPrefix        String   @default("SPH/{YYYY}/")
  sphNextNum       Int      @default(1)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// Bank Accounts
model BankAccount {
  id          String   @id @default(uuid())
  bankName    String
  accountNum  String
  holderName  String
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
